- hosts: localhost
  become: yes
  vars:
    client_list: [172.16.16.3, 172.16.16.14, 172.16.16.15, 172.16.16.16, 172.16.16.17, 172.16.16.18, 172.16.16.19, 172.16.16.20, 172.16.16.21, 172.16.16.22, 172.16.16.23, 172.16.16.24, 172.16.16.25, 172.16.16.26, 172.16.16.27, 172.16.16.28, 172.16.16.29, 172.16.16.30, 172.16.16.31, 172.16.16.32, 172.16.16.33, 172.16.16.34, 172.16.16.35, 172.16.16.36, 172.16.16.37, 172.16.16.38, 172.16.16.39, 172.16.16.40, 172.16.16.41, 172.16.16.42, 172.16.16.43, 172.16.16.44, 172.16.16.45, 172.16.16.46, 172.16.16.47, 172.16.16.48, 172.16.16.49, 172.16.16.50, 172.16.16.51, 172.16.16.52, 172.16.16.53, 172.16.16.54, 172.16.16.55, 172.16.16.56, 172.16.16.57, 172.16.16.58, 172.16.16.59, 172.16.16.60, 172.16.16.61, 172.16.16.62, 172.16.16.63, 172.16.16.64, 172.16.16.65, 172.16.16.66, 172.16.16.67, 172.16.16.68, 172.16.16.69, 172.16.16.70, 172.16.16.71, 172.16.16.72, 172.16.16.73, 172.16.16.74, 172.16.16.75, 172.16.16.76, 172.16.16.77, 172.16.16.78, 172.16.16.79, 172.16.16.80, 172.16.16.81, 172.16.16.82, 172.16.16.83, 172.16.16.84, 172.16.16.85, 172.16.16.86, 172.16.16.87, 172.16.16.88, 172.16.16.89, 172.16.16.90, 172.16.16.91, 172.16.16.92, 172.16.16.93, 172.16.16.94, 172.16.16.95, 172.16.16.96, 172.16.16.97, 172.16.16.98, 172.16.16.99, 172.16.16.100, 172.16.16.101, 172.16.16.102, 172.16.16.103, 172.16.16.104, 172.16.16.105, 172.16.16.106, 172.16.16.107, 172.16.16.108, 172.16.16.109, 172.16.16.110, 172.16.16.111, 172.16.16.112, 172.16.16.113, 172.16.16.114, 172.16.16.115, 172.16.16.116, 172.16.16.117, 172.16.16.118, 172.16.16.119, 172.16.16.120, 172.16.16.121, 172.16.16.122, 172.16.16.123, 172.16.16.124, 172.16.16.125, 172.16.16.126, 172.16.16.127, 172.16.16.128, 172.16.16.129, 172.16.16.130, 172.16.16.131, 172.16.16.132, 172.16.16.133, 172.16.16.134, 172.16.16.135, 172.16.16.136, 172.16.16.137, 172.16.16.138, 172.16.16.139, 172.16.16.140, 172.16.16.141, 172.16.16.142, 172.16.16.143, 172.16.16.144, 172.16.16.145, 172.16.16.146, 172.16.16.147, 172.16.16.148, 172.16.16.149, 172.16.16.150, 172.16.16.151, 172.16.16.152, 172.16.16.153, 172.16.16.154, 172.16.16.155, 172.16.16.156, 172.16.16.157, 172.16.16.158, 172.16.16.159, 172.16.16.160, 172.16.16.161, 172.16.16.162, 172.16.16.163, 172.16.16.164, 172.16.16.165, 172.16.16.166, 172.16.16.167, 172.16.16.168, 172.16.16.169, 172.16.16.170, 172.16.16.171, 172.16.16.172, 172.16.16.173, 172.16.16.174, 172.16.16.175, 172.16.16.176, 172.16.16.177, 172.16.16.178, 172.16.16.179, 172.16.16.180, 172.16.16.181, 172.16.16.182, 172.16.16.183, 172.16.16.184, 172.16.16.185, 172.16.16.186, 172.16.16.187, 172.16.16.188, 172.16.16.189, 172.16.16.190, 172.16.16.191, 172.16.16.192, 172.16.16.193, 172.16.16.194, 172.16.16.195, 172.16.16.196, 172.16.16.197, 172.16.16.198, 172.16.16.199, 172.16.16.200, 172.16.16.201, 172.16.16.202, 172.16.16.203, 172.16.16.204, 172.16.16.205, 172.16.16.206, 172.16.16.207, 172.16.16.208, 172.16.16.209, 172.16.16.210, 172.16.16.211, 172.16.16.212, 172.16.16.213, 172.16.16.214, 172.16.16.215, 172.16.16.216, 172.16.16.217, 172.16.16.218, 172.16.16.219, 172.16.16.220, 172.16.16.221, 172.16.16.222, 172.16.16.223, 172.16.16.224, 172.16.16.225, 172.16.16.226, 172.16.16.227, 172.16.16.228, 172.16.16.229, 172.16.16.230, 172.16.16.231, 172.16.16.232, 172.16.16.233, 172.16.16.234, 172.16.16.235, 172.16.16.236, 172.16.16.237, 172.16.16.238, 172.16.16.239, 172.16.16.240, 172.16.16.241, 172.16.16.242, 172.16.16.243, 172.16.16.244, 172.16.16.245, 172.16.16.246, 172.16.16.247, 172.16.16.248, 172.16.16.249, 172.16.16.250, 172.16.16.251, 172.16.16.252, 172.16.16.253, 172.16.16.254, 172.16.16.255, 172.16.17.0, 172.16.17.1, 172.16.17.2, 172.16.17.3, 172.16.17.4, 172.16.17.5, 172.16.17.6, 172.16.17.7, 172.16.17.8, 172.16.17.9, 172.16.17.10, 172.16.17.11, 172.16.17.12, 172.16.17.13, 172.16.17.14, 172.16.17.15, 172.16.17.16, 172.16.17.17, 172.16.17.18, 172.16.17.19, 172.16.17.20, 172.16.17.21, 172.16.17.22, 172.16.17.23, 172.16.17.24, 172.16.17.25, 172.16.17.26, 172.16.17.27, 172.16.17.28, 172.16.17.29, 172.16.17.30, 172.16.17.31, 172.16.17.32, 172.16.17.33, 172.16.17.34, 172.16.17.35, 172.16.17.36, 172.16.17.37, 172.16.17.38, 172.16.17.39, 172.16.17.40, 172.16.17.41, 172.16.17.42, 172.16.17.43, 172.16.17.44, 172.16.17.45, 172.16.17.46, 172.16.17.47, 172.16.17.48, 172.16.17.49, 172.16.17.50, 172.16.17.51, 172.16.17.52, 172.16.17.53, 172.16.17.54, 172.16.17.55, 172.16.17.56, 172.16.17.57, 172.16.17.58, 172.16.17.59, 172.16.17.60, 172.16.17.61, 172.16.17.62, 172.16.17.63, 172.16.17.64, 172.16.17.65, 172.16.17.66, 172.16.17.67, 172.16.17.68, 172.16.17.69, 172.16.17.70, 172.16.17.71, 172.16.17.72, 172.16.17.73, 172.16.17.74, 172.16.17.75, 172.16.17.76, 172.16.17.77, 172.16.17.78, 172.16.17.79, 172.16.17.80, 172.16.17.81, 172.16.17.82, 172.16.17.83, 172.16.17.84, 172.16.17.85, 172.16.17.86, 172.16.17.87, 172.16.17.88, 172.16.17.89, 172.16.17.90, 172.16.17.91, 172.16.17.92, 172.16.17.93, 172.16.17.94]
  
    test_bandwidth: 10M
    test_duration: 600
    async_timeout: 700
  tasks:
    - name: Одновременный запуск тестов
      command: >
        iperf3 -c {{ item }} -t {{ test_duration }} -i 10 -R -u -b {{ test_bandwidth }}
      with_items: "{{ client_list }}"
      async: "{{ async_timeout }}"
      poll: 0
      register: test_results
      ignore_errors: true

    - name: Awayt iperf3 processes
      async_status:
        jid: "{{ item.ansible_job_id }}"
      register: job_status
      until: job_status.finished
      retries: 5
      delay: 125
      with_items: "{{ test_results.results }}"
      when: item.finished == 0
      ignore_errors: true

    - name: Save results to file
      copy:
        content: >
          {{
            job_status.results
            | selectattr('finished', 'equalto', 1)
            | map(attribute='stdout')
            | reject('equalto', None)
            | join('\n')
          }}
        dest: /root/iperf_results2.log
      become: true
      become_user: root

    - name: Serialize test results
      set_fact:
        test_results: "{{ job_status.results | map(attribute='stdout') | list }}"
    
    # Show me test results
    - debug:
        var: test_results

